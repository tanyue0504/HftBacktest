# HftBacktest

**HftBacktest** æ˜¯ä¸€ä¸ªåŸºäº Python çš„ç®€æ˜“é«˜é¢‘äº¤æ˜“å›æµ‹æ¡†æ¶ï¼Œä¸“ä¸ºæ¨¡æ‹ŸçœŸå®å¸‚åœºç¯å¢ƒä¸‹çš„å»¶è¿Ÿå’Œå¾®è§‚ç»“æ„è®¾è®¡ã€‚

## ğŸ¯ è®¾è®¡æ€è·¯

1.  **äº‹ä»¶é©±åŠ¨æ ¸å¿ƒ**ï¼šæ¡†æ¶çš„æœ€é¡¶å±‚æ˜¯äº‹ä»¶ä¸äº‹ä»¶å¼•æ“ (`EventEngine`)ï¼Œè´Ÿè´£æ¥æ”¶å’ŒæŒ‰æ—¶é—´é¡ºåºä¸¥æ ¼æ¨é€äº‹ä»¶ã€‚
2.  **ç»„ä»¶åŒ–æ¶æ„**ï¼šæ‰€æœ‰åŠŸèƒ½æ¨¡å—ï¼ˆç­–ç•¥ã€è´¦æˆ·ã€æ’®åˆç­‰ï¼‰å‡ä½œä¸º `Component` æ¥å…¥å¼•æ“ï¼Œé€šè¿‡ç›‘å¬ç‰¹å®šäº‹ä»¶è¿›è¡Œå¤„ç†ï¼Œå¹¶å¹¿æ’­å¤„ç†ç»“æœï¼ˆå¦‚è®¢å•çŠ¶æ€æ›´æ–°ï¼‰ã€‚
3.  **åŒç«¯å»¶è¿Ÿæ¨¡æ‹Ÿ**ï¼š
    * **Server ç«¯**ï¼šä»£è¡¨äº¤æ˜“æ‰€ï¼Œå¤„ç†æ’®åˆã€ç»“ç®—ã€è´¦æˆ·èµ„é‡‘ã€‚
    * **Client ç«¯**ï¼šä»£è¡¨æœ¬åœ°ç­–ç•¥ï¼Œå¤„ç†ä¿¡å·ç”Ÿæˆã€é£æ§ã€‚
    * **é›¶å»¶è¿Ÿå†…éƒ¨é€šä¿¡**ï¼šç›´æ¥ç›‘å¬åŒä¸€å¼•æ“çš„ç»„ä»¶ä¹‹é—´æ— å»¶è¿Ÿã€‚
    * **DelayBus æ€»çº¿**ï¼šè¿æ¥ Server å’Œ Client ä¸¤ä¸ªå¼•æ“ï¼Œæ¨¡æ‹ŸçœŸå®çš„ **ç½‘ç»œå»¶è¿Ÿï¼ˆLatencyï¼‰**ï¼Œå®ç°è¡Œæƒ…æ¨é€å’Œè®¢å•å›æŠ¥çš„å¼‚æ­¥ä¼ è¾“ã€‚
4.  **ç±»å‹ä¸¥æ ¼**ï¼šäº‹ä»¶æ”¯æŒç»§æ‰¿ï¼Œä½†åœ¨æ³¨å†Œç›‘å¬æ—¶é‡‡ç”¨ä¸¥æ ¼ç±»å‹åŒ¹é…ï¼Œç¡®ä¿é€»è¾‘å¤„ç†çš„ç²¾ç¡®æ€§ã€‚

## ğŸ§© æ¨¡å—è¯¦è§£

### 1. æ ¸å¿ƒç»„ä»¶ (`hft_backtest`)
* **`event_engine`**: å›æµ‹çš„æ ¸å¿ƒå¿ƒè„ã€‚æä¾› `register`ï¼ˆæ³¨å†Œç›‘å¬ï¼‰å’Œ `put`ï¼ˆæ¨é€äº‹ä»¶ï¼‰æ–¹æ³•ï¼Œç¡®ä¿äº‹ä»¶é˜Ÿåˆ—æŒ‰æ—¶é—´æˆ³é¡ºåºæ‰§è¡Œã€‚ç»„ä»¶éœ€å…ˆ `derive` äº‹ä»¶å†ä¿®æ”¹çŠ¶æ€ï¼Œé¿å…å¼•ç”¨æ±¡æŸ“ã€‚
* **`delay_bus`**: é«˜é¢‘å›æµ‹çš„çµé­‚ç»„ä»¶ã€‚å®ƒç›‘å¬ Source å¼•æ“çš„äº‹ä»¶ï¼Œå¢åŠ è®¾å®šçš„å»¶è¿Ÿæ—¶é—´ï¼ˆmsï¼‰åï¼Œå†æ¨é€åˆ° Target å¼•æ“ã€‚
    * Server -> Client: æ¨¡æ‹Ÿè¡Œæƒ…æ•°æ®ä¼ è¾“å»¶è¿Ÿã€æˆäº¤å›æŠ¥å»¶è¿Ÿã€‚
    * Client -> Server: æ¨¡æ‹Ÿè®¢å•å‘é€å»¶è¿Ÿã€æ’¤å•è¯·æ±‚å»¶è¿Ÿã€‚
* **`dataset`**: å®šä¹‰æ ‡å‡† `Data` äº‹ä»¶ã€‚æ”¯æŒ **MergedDataset**ï¼Œå¯å°† Tradesã€BookTickerã€FundingRate ç­‰å¤šæºæ•°æ®æŒ‰æ—¶é—´æˆ³å½’å¹¶å›æ”¾ã€‚

### 2. äº¤æ˜“ç»„ä»¶
* **`match_engine`**: äº¤æ˜“æ‰€æ’®åˆé€»è¾‘ã€‚
    * ç›‘å¬ `SUBMITTED` çŠ¶æ€è®¢å•ã€‚
    * ç»´æŠ¤ OrderBookï¼Œè®¡ç®—é™ä»·å•çš„æ’ä½ï¼ˆRankï¼‰ï¼Œæ¨¡æ‹Ÿè¢«åŠ¨æˆäº¤ã€‚
    * æ”¯æŒ OKX å’Œ Binance çš„ç‰¹å®šæ’®åˆè§„åˆ™ã€‚
* **`account`**: è´¦æˆ·èµ„é‡‘ç®¡ç†ã€‚
    * ç»´æŠ¤è®¢å•çŠ¶æ€æœºï¼ˆSubmitted -> Received -> Filled/Canceledï¼‰ã€‚
    * å¤„ç† `Data:trade` äº‹ä»¶æ›´æ–°æ ‡è®°ä»·æ ¼ã€‚
    * æä¾› `get_positions`ã€`get_equity` ç­‰æŸ¥è¯¢æ¥å£ã€‚
* **`recorder`**: æ•°æ®è®°å½•ã€‚
    * ç›‘å¬æˆäº¤äº‹ä»¶è®°å½• `trade.csv`ã€‚
    * å®šæœŸå¿«ç…§è´¦æˆ·çŠ¶æ€ï¼ˆæƒç›Šã€ä¿è¯é‡‘ã€PnLï¼‰åˆ° `snapshots.csv`ã€‚

### 3. ç­–ç•¥å¼€å‘
* **`strategy`**: ç”¨æˆ·ç­–ç•¥åŸºç±»ã€‚
    * éœ€ç»§æ‰¿å¹¶å®ç° `on_data` æˆ–æ³¨å†Œå…¶ä»–äº‹ä»¶å›è°ƒã€‚
    * æä¾› `send_order` æ¥å£ï¼ˆæ³¨ï¼šè¯·ä½¿ç”¨ `Order` çš„å·¥å‚æ–¹æ³•åˆ›å»ºå®ä¾‹ï¼‰ã€‚
    * **æ³¨æ„**ï¼šæ‰€æœ‰å›è°ƒå‡½æ•°éœ€è¦å¼€å‘è€…æ‰‹åŠ¨åœ¨ `start` æ–¹æ³•ä¸­æ³¨å†Œç›‘å¬ã€‚

### 4. `backtest_engine`
ç»„è£…æ•´ä¸ªå›æµ‹ç³»ç»Ÿçš„å…¥å£ç±»ï¼Œè´Ÿè´£ï¼š
1.  åˆ›å»ºåŒç«¯äº‹ä»¶å¼•æ“ (Server/Client)ã€‚
2.  æ„å»ºåŒå‘ DelayBusã€‚
3.  è½½å…¥æ•°æ®é›†ã€‚
4.  æŒ‰é¡ºåºæ·»åŠ ç»„ä»¶ï¼ˆæ’®åˆã€è´¦æˆ·ã€ç­–ç•¥ç­‰ï¼‰ã€‚

> **âš ï¸ åˆå§‹åŒ–é¡ºåºè­¦å‘Š**ï¼šç»„ä»¶æ·»åŠ é¡ºåºéå¸¸å…³é”®ã€‚å»ºè®®éµå¾ª `Matcher -> ServerAccount -> Recorder -> ClientAccount -> Strategy` çš„é¡ºåºï¼Œé˜²æ­¢ç­–ç•¥å…ˆæ”¶åˆ°å›æŠ¥è€Œè´¦æˆ·å°šæœªæ›´æ–°çŠ¶æ€çš„æƒ…å†µã€‚

## ğŸ—ï¸ æ¶æ„å›¾è§£

```mermaid
graph TD
    subgraph "äº¤æ˜“æ‰€ç«¯ (Server Engine)"
        Matcher[æ’®åˆå¼•æ“]
        ServerAcc[äº¤æ˜“æ‰€è´¦æˆ·]
        Settlement[ç»“ç®—å¼•æ“]
    end

    subgraph "ç­–ç•¥ç«¯ (Client Engine)"
        Strategy[ç”¨æˆ·ç­–ç•¥]
        ClientAcc[æœ¬åœ°å½±å­è´¦æˆ·]
    end

    Data[æ•°æ®æº (Dataset)] -->|è¡Œæƒ…æ¨é€| ServerEngine
    
    %% å†…éƒ¨äº¤äº’
    ServerEngine <--> Matcher
    ServerEngine <--> ServerAcc
    
    ClientEngine <--> Strategy
    ClientEngine <--> ClientAcc

    %% å»¶è¿Ÿäº¤äº’
    ServerEngine -->|è¡Œæƒ…/å›æŠ¥ (Delay)| BusS2C[DelayBus S->C]
    BusS2C --> ClientEngine
    
    ClientEngine -->|ä¸‹å•/æ’¤å• (Delay)| BusC2S[DelayBus C->S]
    BusC2S --> ServerEngine
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. å®‰è£…
```bash
# 1. å®‰è£…ä¾èµ–
pip install -r requirements.txt

# 2. ç¼–è¯‘ Cython æ‰©å±• (å¿…é¡»)
python setup.py build_ext --inplace
```

### 2. è¿è¡Œç¤ºä¾‹
å‚è€ƒ `test/binance/demo.py` æˆ– `test/okx/demo.py`ï¼š

```python
from hft_backtest import BacktestEngine, MergedDataset
from hft_backtest.binance import BinanceMatcher, BinanceAccount, BinanceRecorder
# ... å¯¼å…¥ä½ çš„æ•°æ®ç±»å’Œç­–ç•¥ç±»

def main():
    # 1. å‡†å¤‡æ•°æ®
    ds = MergedDataset(bookticker_ds, trades_ds)
    
    # 2. åˆå§‹åŒ–å¼•æ“ (è®¾ç½® 10ms ç½‘ç»œå»¶è¿Ÿ)
    engine = BacktestEngine(datasets=[ds], delay=10)
    
    # 3. æ·»åŠ æœåŠ¡ç«¯ç»„ä»¶
    engine.add_component(BinanceMatcher(), is_server=True)
    engine.add_component(BinanceAccount(), is_server=True)
    
    # 4. æ·»åŠ å®¢æˆ·ç«¯ç»„ä»¶
    engine.add_component(MyStrategy(), is_server=False)
    
    # 5. è¿è¡Œ
    engine.run()
```

## ğŸ“Š æ€§èƒ½è¯´æ˜

* **å†…å­˜ä¼˜åŒ–**: å³ä½¿æ•°æ®é‡å·¨å¤§ï¼ˆå¦‚å•æœˆ BookTicker 80G+ï¼‰ï¼Œé€šè¿‡ `chunksize` åˆ†å—è¯»å–å’Œé€è¡Œæ¨é€ï¼Œå¯ä¿æŒä½å†…å­˜å ç”¨ã€‚
* **è®¡ç®—æ€§èƒ½**: 
    * æ ¸å¿ƒäº‹ä»¶å¯¹è±¡ä½¿ç”¨ Cython ä¼˜åŒ–ã€‚
    * Dataset è¯»å–æ”¯æŒ Parquetï¼Œé€Ÿåº¦æ˜¾è‘—ä¼˜äº CSVã€‚
    * æµ‹è¯•è¡¨æ˜ï¼ŒBTCUSDT å•æ—¥å…¨é‡ Tick æ•°æ®ï¼ˆ2000ä¸‡è¡Œ+ï¼‰ç©ºæ¨ä»…éœ€ 1 åˆ†é’Ÿå·¦å³ã€‚

## ğŸ“„ License
MIT License